<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cartographie acteurs de la Formation Professionnelle R√©union 2026 ‚Äî Mind map + Carte</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    :root{
      --c0:#000000;  /* noir */
      --c1:#fc772c;  /* orange */
      --c2:#5c646b;  /* gris */
      --c3:#f1d7bc;  /* beige */
      --c4:#ce2a45;  /* rouge */

      --textOnDark: rgba(255,255,255,.92);
      --mutedOnDark: rgba(255,255,255,.72);

      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --shadowSoft: 0 14px 45px rgba(0,0,0,.35);

      --ease:cubic-bezier(.2,.85,.25,1);
      --dur:260ms;
      --radius: 18px;

      --hub: clamp(104px, 10vw, 140px);
      --node: clamp(102px, 12vw, 150px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--textOnDark);
      overflow-x:hidden;
      background:
        radial-gradient(900px 600px at 18% 22%, rgba(252,119,44,.20), transparent 60%),
        radial-gradient(900px 700px at 78% 20%, rgba(206,42,69,.20), transparent 55%),
        radial-gradient(1100px 900px at 50% 92%, rgba(92,100,107,.18), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,1), rgba(0,0,0,1));
      min-height:100vh;
    }

    /* d√©cor */
    .bg-shapes{position:fixed; inset:0; pointer-events:none; opacity:.95;}
    .plus{position:absolute; width:34px; height:34px; opacity:.65; filter: drop-shadow(0 10px 25px rgba(0,0,0,.6));}
    .plus:before,.plus:after{content:""; position:absolute; inset:0; margin:auto; background:rgba(252,119,44,.65); border-radius:2px;}
    .plus:before{width:6px; height:34px;}
    .plus:after{width:34px; height:6px;}
    .tri{position:absolute; width:0; height:0; border-left:16px solid transparent; border-right:16px solid transparent; border-bottom:26px solid rgba(241,215,188,.20); transform: rotate(-18deg); opacity:.7;}
    .ring{position:absolute; width:46px; height:46px; border:6px solid rgba(206,42,69,.35); border-right-color: transparent; border-top-color: transparent; border-radius:999px; opacity:.70;}

    header{
      padding: 18px 18px 10px;
      max-width: 1400px;
      margin: 0 auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
    }
    header h1{margin:0; font-size: clamp(18px, 2.1vw, 28px)}
    header p{margin:6px 0 0; color: var(--mutedOnDark); font-size: 14px; line-height:1.45; max-width: 92ch}

    .switch{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .chip{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      transition: transform var(--dur) var(--ease), background var(--dur) var(--ease);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .chip:hover{transform: translateY(-1px); background: rgba(255,255,255,.14)}
    .chip.active{
      background: linear-gradient(90deg, rgba(252,119,44,.95), rgba(206,42,69,.90));
      border-color: rgba(255,255,255,.22);
    }

    .wrap{max-width: 1400px; margin: 0 auto; padding: 10px 18px 18px;}
    .view{display:none;}
    .view.active{display:block;}
    .card{
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    /* =======================
      VIEW 1 ‚Äî MIND MAP (PAYSAGE)
    ======================= */
    .mm-grid{
      display:grid;
      grid-template-columns: 1fr;
      grid-template-rows: auto auto;
      gap: 14px;
      align-items:stretch;
    }

    .mindmap{
      position:relative;
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 520px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
      backdrop-filter: blur(10px);
    }

    .stage{
      position:relative;
      width: min(1180px, 100%);
      aspect-ratio: 16 / 9;
      display:grid;
      place-items:center;
    }

    .blob{
      position:absolute;
      width: 240px; height: 170px;
      background: rgba(241,215,188,.10);
      border: 1px solid rgba(241,215,188,.10);
      border-radius: 62% 38% 55% 45% / 45% 60% 40% 55%;
      box-shadow: 0 25px 80px rgba(0,0,0,.35);
      opacity:.65;
      z-index:0;
    }

    svg.connectors{position:absolute; inset:0; width:100%; height:100%; z-index:1; pointer-events:none; overflow:visible;}
    .link{
      stroke: rgba(241,215,188,.35);
      stroke-width: 2;
      fill:none;
      stroke-linecap:round;
      stroke-dasharray: 8 8;
      opacity:.85;
      transition: opacity var(--dur) var(--ease), stroke-dasharray var(--dur) var(--ease), stroke var(--dur) var(--ease);
    }
    .link.is-active{opacity:1; stroke-dasharray:none; stroke: rgba(252,119,44,.95);}

    .hub{
      position:relative;
      width: var(--hub);
      height: var(--hub);
      border-radius: 55% 45% 60% 40% / 45% 58% 42% 55%;
      background: linear-gradient(180deg, rgba(241,215,188,.98), rgba(241,215,188,.90));
      box-shadow: var(--shadowSoft);
      border: 1px solid rgba(0,0,0,.10);
      display:grid;
      place-items:center;
      padding: 10px;
      z-index:3;
      color: #000;
    }
    .hub .center-title{font-weight: 950; font-size: clamp(12px, 1.4vw, 15px); line-height:1.15; text-align:center;}

    .node{
      position:absolute;
      width: var(--node);
      height: var(--node);
      border-radius: 60% 40% 54% 46% / 42% 58% 42% 58%;
      background: linear-gradient(180deg, rgba(241,215,188,.98), rgba(241,215,188,.90));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: var(--shadowSoft);
      color: #000;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 12px;
      cursor:pointer;
      user-select:none;
      z-index:2;
      transform: translate(-50%,-50%) translateZ(0);
      transition: transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease), filter var(--dur) var(--ease);
      outline:none;
    }
    .node:hover{transform: translate(-50%,-50%) scale(1.04); filter: brightness(1.02); box-shadow: 0 18px 45px rgba(0,0,0,.45);}
    .node.is-active{transform: translate(-50%,-50%) scale(1.08); box-shadow: 0 22px 55px rgba(0,0,0,.55); outline: 2px solid rgba(252,119,44,.70);}
    .node:focus-visible{box-shadow: 0 0 0 4px rgba(252,119,44,.35), 0 22px 55px rgba(0,0,0,.55);}

    .node .tag{
      position:absolute; top:-12px; left:12px;
      display:flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius: 12px;
      color:#fff; font-weight:950; font-size: 11px;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      letter-spacing:.2px; white-space:nowrap;
    }
    .node .tag .dot{width:10px; height:10px; border-radius:999px; background: rgba(255,255,255,.92); box-shadow: inset 0 0 0 2px rgba(0,0,0,.12);}
    .node .label{font-weight: 950; font-size: 13px; line-height:1.15; padding-top: 10px;}
    .node .mini{display:block; margin-top:6px; font-size: 11px; font-weight: 900; color: rgba(92,100,107,.95);}

    /* ‚úÖ Panneau en dessous (paysage) */
    .panel{
      border-radius: var(--radius);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      min-height: 380px;
    }
    .panel-header{
      background: linear-gradient(90deg, rgba(252,119,44,.95), rgba(206,42,69,.90));
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .panel-header h2{margin:0; font-size: 14px; letter-spacing:.2px;}
    .panel-header .badge{
      font-size: 11px; font-weight: 950;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.18);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }

    /* ‚úÖ 2 colonnes (paysage) */
    .panel-body{
      padding: 16px;
      overflow:auto;
      flex:1;
      max-height: 360px;
    }
    .mm-card{
      background: linear-gradient(180deg, rgba(241,215,188,.98), rgba(241,215,188,.90));
      color: #000;
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadowSoft);
      border: 1px solid rgba(0,0,0,.10);
      transform-origin: top;
      transition: transform var(--dur) var(--ease), opacity var(--dur) var(--ease);
    }
    .mm-card.is-enter{opacity:0; transform: translateY(8px) scale(.98);}

    .mm-layout{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      align-items:start;
    }
    .mm-left h3{margin:0 0 8px; font-size: 15px; letter-spacing:.2px;}
    .mm-left p{margin:0 0 10px; color: rgba(0,0,0,.82); font-size: 13px; line-height:1.45;}
    .mm-left ul{margin: 0 0 10px; padding-left: 18px; color: rgba(0,0,0,.82); font-size: 13px; line-height:1.45;}
    .mm-left li{margin: 6px 0}
    .mm-left h4{margin:14px 0 8px; font-size:13px; letter-spacing:.2px; color:#000;}

    .mm-right{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .sidebox{
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 18px;
      padding: 12px;
    }
    .sidebox .title{
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.2px;
      margin:0 0 8px;
      color: rgba(0,0,0,.90);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill-row{display:flex; flex-wrap:wrap; gap:8px;}
    .pill{
      background: linear-gradient(90deg, rgba(92,100,107,.95), rgba(0,0,0,.92));
      border: 1px solid rgba(0,0,0,.18);
      color:#fff;
      font-weight: 950;
      font-size: 11px;
      padding: 7px 10px;
      border-radius: 999px;
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .action{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.50);
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      font-weight: 900;
      font-size: 12px;
    }
    .action small{font-weight: 800; color: rgba(0,0,0,.65)}
    .action .k{
      font-weight: 950;
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(252,119,44,.20);
      border: 1px solid rgba(252,119,44,.25);
    }

    .panel-footer{
      padding: 12px 16px 14px;
      display:flex; gap:10px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
    }
    .btn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      transition: transform var(--dur) var(--ease), background var(--dur) var(--ease);
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.14)}
    .btn.primary{
      background: linear-gradient(90deg, rgba(252,119,44,.95), rgba(206,42,69,.90));
      border-color: rgba(255,255,255,.22);
    }

    /* =======================
      VIEW 2 ‚Äî CARTE + TABLE
    ======================= */
    .map-grid{display:grid; grid-template-columns: 1.35fr .85fr; gap: 14px; align-items:stretch;}
    .map-head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .map-head b{font-size: 13px}
    .map-head span{display:block; font-size: 12px; color: var(--mutedOnDark); margin-top:3px}
    #map{width:100%; min-height: 650px;}

    .side{display:flex; flex-direction:column; min-height: 650px;}
    .side-head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      display:flex; flex-direction:column; gap:10px;
    }
    .filters{display:grid; grid-template-columns: 1fr; gap: 8px;}
    .filters input, .filters select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color:#fff;
      outline:none;
    }
    .filters input::placeholder{color: rgba(255,255,255,.55)}
    .meta{display:flex; justify-content:space-between; gap:10px; color: var(--mutedOnDark); font-size: 12px;}
    .note{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.80);
      font-size: 12px;
      line-height:1.4;
    }

    .table-wrap{padding: 10px 14px 14px; overflow:auto; flex:1;}
    table{width:100%; border-collapse: collapse; font-size: 12.5px;}
    th, td{padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,.10); vertical-align:top; text-align:left;}
    th{
      position:sticky; top:0;
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      z-index:2;
      font-size: 12px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.88);
    }
    tr.row{cursor:pointer; transition: background var(--dur) var(--ease);}
    tr.row:hover{background: rgba(255,255,255,.06)}
    tr.row.active{background: rgba(252,119,44,.16); outline: 1px solid rgba(252,119,44,.32);}

    .badge{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      white-space:nowrap;
    }
    .badge.ok{background: rgba(241,215,188,.12)}
    .badge.no{background: rgba(206,42,69,.18)}
    .custom-marker{background: transparent; border: none;}

    @media (max-width: 1050px){
      .map-grid{grid-template-columns: 1fr}
      #map, .side{min-height: 520px}
      .mindmap{min-height: 520px}
      .panel{min-height: 420px}
      .stage{aspect-ratio: 4/3}
      .mm-layout{grid-template-columns: 1fr;}
      .panel-body{max-height: none;}
    }
  </style>
</head>

<body>
  <div class="bg-shapes" aria-hidden="true">
    <div class="plus" style="top:12%; left:86%; transform:scale(1.0) rotate(0deg);"></div>
    <div class="plus" style="top:72%; left:14%; transform:scale(.85) rotate(12deg); opacity:.55;"></div>
    <div class="plus" style="top:28%; left:22%; transform:scale(.75) rotate(-8deg); opacity:.45;"></div>
    <div class="tri"  style="top:18%; left:8%; opacity:.55;"></div>
    <div class="ring" style="top:24%; left:10%;"></div>
    <div class="ring" style="top:62%; left:90%; transform:scale(.85) rotate(20deg); opacity:.55;"></div>
  </div>

  <header>
    <div>
      <h1>Cartographie acteurs FP R√©union (2026)</h1>
      <p>
        Mind map en <b>format paysage</b> + panneau <b>2 colonnes</b> en bas. Carte + table pour les acteurs avec adresse postale.
      </p>
    </div>
    <div class="switch" role="tablist" aria-label="Changer de vue">
      <button class="chip active" id="btnMind" type="button" role="tab" aria-selected="true">üß† Mind map</button>
      <button class="chip" id="btnMap" type="button" role="tab" aria-selected="false">üó∫Ô∏è Carte + table</button>
    </div>
  </header>

  <div class="wrap">
    <!-- VIEW 1 ‚Äî MIND MAP -->
    <section class="view active" id="viewMind" aria-label="Mind map">
      <div class="mm-grid">
        <div class="mindmap card">
          <div class="stage" id="mmStage">
            <div class="blob" style="top:10%; left:10%; transform:rotate(-10deg) scale(1.05)"></div>
            <div class="blob" style="top:8%; left:72%; transform:rotate(12deg) scale(.95)"></div>
            <div class="blob" style="top:68%; left:14%; transform:rotate(8deg) scale(.92)"></div>
            <div class="blob" style="top:70%; left:72%; transform:rotate(-14deg) scale(1.02)"></div>

            <svg class="connectors" id="mmSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true"></svg>

            <div class="hub" id="mmHub">
              <div class="center-title" id="mmCenterTitle">Acteurs formation pro<br>R√©union (2026)</div>
            </div>
          </div>
        </div>

        <aside class="panel">
          <div class="panel-header">
            <h2 id="mmPanelTitle">Introduction</h2>
            <div class="badge" id="mmPanelBadge">7 branches</div>
          </div>

          <div class="panel-body">
            <div class="mm-card is-enter" id="mmCard">
              <div class="mm-layout">
                <div class="mm-left">
                  <h3>üìå √Ä propos du document</h3>
                  <p>Cartographie exhaustive des acteurs de la formation professionnelle √† La R√©union (sources annonc√©es : DEETS, R√©gion, Formanoo, Portail SPRO 2025-2026).</p>
                  <ul>
                    <li><b>Public cible</b> : formateurs FPA, apprenants adultes, entreprises, partenaires insertion</li>
                    <li><b>Focus</b> : √Æle compl√®te avec priorit√© Sud</li>
                    <li><b>Orientation</b> : formation + accompagnement social</li>
                  </ul>
                </div>
                <div class="mm-right">
                  <div class="sidebox">
                    <p class="title">üè∑Ô∏è Tags</p>
                    <div class="pill-row" aria-hidden="true">
                      <span class="pill">R√©union</span><span class="pill">Insertion</span><span class="pill">Annuaire</span>
                    </div>
                  </div>
                  <div class="sidebox">
                    <p class="title">‚ö° Actions</p>
                    <div class="actions">
                      <div class="action"><span>Conseil : ajoute/√©dite les contenus</span><span class="k">MM_DATA</span></div>
                      <div class="action"><span>Conseil : ajoute les acteurs carte</span><span class="k">ACTEURS</span></div>
                      <div class="action"><span>Astuce : cache g√©ocodage</span><small>localStorage</small></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel-footer">
            <button class="btn primary" id="mmResetBtn" type="button">Retour intro</button>
            <button class="btn" id="mmExpandBtn" type="button">Ouvrir branche 1</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- VIEW 2 ‚Äî MAP + TABLE -->
    <section class="view" id="viewMap" aria-label="Carte et table">
      <div class="map-grid">
        <section class="card">
          <div class="map-head">
            <div>
              <b>Carte (cat√©gories)</b>
              <span>Filtre cat√©gorie + commune ‚Ä¢ Marqueur ‚Üî ligne</span>
            </div>
            <div class="map-actions">
              <button class="btn" id="fitBtn" type="button">Ajuster la vue</button>
              <button class="btn" id="regeoBtn" type="button">Re-g√©ocoder</button>
              <button class="btn primary" id="clearBtn" type="button">Tout afficher</button>
            </div>
          </div>
          <div id="map"></div>
        </section>

        <aside class="card side">
          <div class="side-head">
            <div class="filters">
              <select id="catSel">
                <option value="TOUTES">Toutes cat√©gories</option>
              </select>
              <select id="communeSel">
                <option value="TOUTES">Toutes communes</option>
              </select>
              <input id="q" type="search" placeholder="Recherche : nom, adresse, t√©l√©phone‚Ä¶" />
            </div>

            <div class="meta">
              <span id="count">0 acteur</span>
              <span id="placed">0 plac√©s</span>
            </div>

            <div class="note">
              ‚ö†Ô∏è G√©ocodage via Nominatim/OSM (internet requis). 1 req/sec + cache navigateur.
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Acteur</th>
                  <th>Cat√©gorie</th>
                  <th>Commune</th>
                  <th>Adresse</th>
                  <th>Carte</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    /* UTIL */
    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function degToRad(deg){ return deg * Math.PI / 180; }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    /* VIEW SWITCH */
    const btnMind = document.getElementById("btnMind");
    const btnMap  = document.getElementById("btnMap");
    const viewMind = document.getElementById("viewMind");
    const viewMap  = document.getElementById("viewMap");
    let mapInitialized = false;

    function setView(name){
      const isMind = name === "mind";
      viewMind.classList.toggle("active", isMind);
      viewMap.classList.toggle("active", !isMind);
      btnMind.classList.toggle("active", isMind);
      btnMap.classList.toggle("active", !isMind);
      btnMind.setAttribute("aria-selected", String(isMind));
      btnMap.setAttribute("aria-selected", String(!isMind));

      if(!isMind){
        initMapOnce();
        setTimeout(() => { if(window.__map) window.__map.invalidateSize(); }, 80);
      }
    }
    btnMind.addEventListener("click", () => setView("mind"));
    btnMap.addEventListener("click",  () => setView("map"));

    /* CATEGORIES + COULEURS */
    const CAT_LABEL = {
      PILOTAGE:"Pilotage",
      FINANCEUR:"Financeur / OPCO",
      OF:"Organisme de formation",
      SPE:"SPE / Insertion",
      RESEAU:"R√©seau / Partenaire"
    };

    function categoryColor(cat){
      switch(cat){
        case "PILOTAGE": return "#000000";
        case "FINANCEUR": return "#5c646b";
        case "OF": return "#fc772c";
        case "SPE": return "#ce2a45";
        case "RESEAU": return "#f1d7bc";
        default: return "#5c646b";
      }
    }

    /* =======================
      1) MIND MAP ‚Äî DATA
    ======================= */
    const MM_DATA = {
      centerTitle: "Acteurs formation pro ‚Äî R√©union (2026)",
      branches: [
        { id:"b1", cat:"PILOTAGE", title:"Pilotage & contr√¥le", subtitle:"Institutionnel / contr√¥le OF", icon:"üèõÔ∏è",
          content:{ intro:"Instances de pilotage et contr√¥le : DEETS, R√©gion‚Ä¶",
            sections:[{heading:"DEETS (extrait)", bullets:["112 rue de la R√©publique, 97400 Saint-Denis","P√¥le contr√¥le : 12 Lot. Lemerle, 97400 Saint-Denis"]}],
            pills:["DEETS","R√©gion","Contr√¥le"] } },
        { id:"b2", cat:"FINANCEUR", title:"Financeurs (OPCO)", subtitle:"11 OPCO par branche", icon:"üí∂",
          content:{ intro:"Financeurs par branches professionnelles. Ressource cit√©e : trouver-mon-opco.fr",
            sections:[{heading:"Exemples", bullets:["OPCO Mobilit√©s (logistique)","OPCO EP","AKTO","OPCO Atlas"]}],
            pills:["OPCO","Financement"] } },
        { id:"b3", cat:"OF", title:"Organismes de formation", subtitle:"Logistique + CFA/OF", icon:"üè´",
          content:{ intro:"OF/CFA logistique : liste annonc√©e (Formanoo 22/01/2026).",
            sections:[{heading:"Extraits", bullets:["AFTRAL (Saint-Paul)","AREFIP (Saint-Pierre)","CCI Campus Pro (Saint-Pierre)","CEFORA (Le Port)"]}],
            pills:["OF/CFA","Logistique"] } },
        { id:"b4", cat:"SPE", title:"SPE & accompagnement", subtitle:"Insertion (focus Sud)", icon:"ü§ù",
          content:{ intro:"France Travail, Missions Locales, Cap Emploi‚Ä¶",
            sections:[{heading:"Extrait", bullets:["France Travail Sud : 40 rue Fran√ßois de Mahy, Saint-Pierre","Missions Locales : Saint-Louis (4 rue du Vieux Moulin)"]}],
            pills:["Insertion","Accompagnement"] } },
        { id:"b5", cat:"RESEAU", title:"Agenda 2026", subtitle:"Semaines / √©v√©nements", icon:"üìÖ",
          content:{ intro:"Rep√®res + semaines th√©matiques (document).",
            sections:[{heading:"Semaines (extrait)", bullets:["Tourisme 2‚Äì8 f√©v. 2026","Nucl√©aire 9‚Äì13 mars 2026","Soin 30 mars‚Äì3 avril 2026"]}],
            pills:["√âv√©nements"] } },
        { id:"b6", cat:"RESEAU", title:"Partenaires logistique", subtitle:"Syndicats & f√©d√©rations", icon:"üöö",
          content:{ intro:"TLF, FNTR‚Ä¶ (local + national).",
            sections:[{heading:"Extrait", bullets:["TLF R√©union (contact au Port)","FNTR (national)"]}],
            pills:["Fili√®re"] } },
        { id:"b7", cat:"RESEAU", title:"R√©seautage pro", subtitle:"Communaut√©s & plateformes", icon:"üåê",
          content:{ intro:"R√©seaux sociaux / plateformes cit√©es.",
            sections:[{heading:"Extrait", bullets:["MonCompteFormation","France Supply Chain","Afilog"]}],
            pills:["R√©seaux"] } },
      ]
    };

    /* MIND MAP ‚Äî RENDER */
    const mmStage = document.getElementById("mmStage");
    const mmSvg = document.getElementById("mmSvg");
    const mmCenterTitle = document.getElementById("mmCenterTitle");
    const mmCard = document.getElementById("mmCard");
    const mmPanelTitle = document.getElementById("mmPanelTitle");
    const mmPanelBadge = document.getElementById("mmPanelBadge");
    const mmResetBtn = document.getElementById("mmResetBtn");
    const mmExpandBtn = document.getElementById("mmExpandBtn");

    mmCenterTitle.innerHTML = MM_DATA.centerTitle.replace(" ‚Äî ", "<br>");

    const mmNodes = new Map();
    const mmLinks = new Map();
    const MM_START_ANGLE_DEG = -110;

    function mmCreateLink(id){
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("class","link");
      path.dataset.id = id;
      mmSvg.appendChild(path);
      mmLinks.set(id, path);
      return path;
    }

    function mmCreateNode(branch){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "node";
      btn.dataset.id = branch.id;
      btn.setAttribute("aria-label", branch.title);

      const color = categoryColor(branch.cat);

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.style.background = color;
      if(String(color).toLowerCase() === "#f1d7bc") tag.style.color = "#000";

      const dot = document.createElement("span");
      dot.className = "dot";
      tag.appendChild(dot);

      const tagText = document.createElement("span");
      tagText.textContent = branch.icon + " " + branch.title;
      tag.appendChild(tagText);

      const label = document.createElement("div");
      label.className = "label";
      label.innerHTML = `${escapeHTML(branch.title)}<span class="mini">${escapeHTML(branch.subtitle)}</span>`;

      btn.appendChild(tag);
      btn.appendChild(label);

      btn.addEventListener("click", () => mmActivate(branch.id));
      btn.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          mmActivate(branch.id);
        }
      });

      mmStage.appendChild(btn);
      mmNodes.set(branch.id, btn);
      return btn;
    }

    function mmLayout(){
      const cx = 50, cy = 50;

      /* ellipse (paysage) */
      const ringX = 44;
      const ringY = 34;

      const count = MM_DATA.branches.length;
      const step = 360 / count;

      MM_DATA.branches.forEach((b, i) => {
        const angle = degToRad(MM_START_ANGLE_DEG + i * step);
        const x = cx + ringX * Math.cos(angle);
        const y = cy + ringY * Math.sin(angle);

        const el = mmNodes.get(b.id);
        el.style.left = x + "%";
        el.style.top = y + "%";

        const p = mmLinks.get(b.id);
        const x1 = cx * 10, y1 = cy * 10;
        const x2 = x * 10,  y2 = y * 10;

        const mx = (x1 + x2)/2;
        const my = (y1 + y2)/2;
        const bend = 95;
        const nx = mx + (y1 - y2) / bend;
        const ny = my + (x2 - x1) / bend;

        p.setAttribute("d", `M ${x1} ${y1} Q ${nx} ${ny} ${x2} ${y2}`);
      });
    }

    function mmDeactivateAll(){
      mmNodes.forEach(n => n.classList.remove("is-active"));
      mmLinks.forEach(l => l.classList.remove("is-active"));
    }

    function mmRender(branch){
      mmCard.classList.add("is-enter");
      window.setTimeout(() => {
        mmPanelTitle.textContent = branch.title;
        mmPanelBadge.textContent = "Branche active";

        const sectionsHTML = (branch.content.sections || []).map(sec => `
          <h4>${escapeHTML(sec.heading)}</h4>
          <ul>
            ${(sec.bullets || []).map(li => `<li>${escapeHTML(li)}</li>`).join("")}
          </ul>
        `).join("");

        const pillsHTML = (branch.content.pills || []).map(p => `<span class="pill">${escapeHTML(p)}</span>`).join("");

        mmCard.innerHTML = `
          <div class="mm-layout">
            <div class="mm-left">
              <h3>${escapeHTML(branch.icon)} ${escapeHTML(branch.title)}</h3>
              <p>${escapeHTML(branch.content.intro || "")}</p>
              ${sectionsHTML}
            </div>
            <div class="mm-right">
              <div class="sidebox">
                <p class="title">üè∑Ô∏è Tags</p>
                <div class="pill-row" aria-hidden="true">${pillsHTML}</div>
              </div>
              <div class="sidebox">
                <p class="title">‚ö° Actions</p>
                <div class="actions">
                  <div class="action"><span>Aller √† la carte (onglet)</span><span class="k">üó∫Ô∏è</span></div>
                  <div class="action"><span>Modifier le contenu</span><span class="k">MM_DATA</span></div>
                  <div class="action"><span>Ajouter des acteurs</span><span class="k">ACTEURS</span></div>
                </div>
              </div>
            </div>
          </div>
        `;
        requestAnimationFrame(() => mmCard.classList.remove("is-enter"));
      }, 40);
    }

    function mmActivate(id){
      const branch = MM_DATA.branches.find(b => b.id === id);
      if(!branch) return;

      mmDeactivateAll();
      mmNodes.get(id).classList.add("is-active");
      mmLinks.get(id).classList.add("is-active");
      mmRender(branch);
    }

    function mmReset(){
      mmDeactivateAll();
      mmPanelTitle.textContent = "Introduction";
      mmPanelBadge.textContent = "7 branches";
      mmCard.classList.add("is-enter");
      window.setTimeout(() => {
        mmCard.innerHTML = `
          <div class="mm-layout">
            <div class="mm-left">
              <h3>üìå √Ä propos du document</h3>
              <p>Cartographie exhaustive des acteurs de la formation professionnelle √† La R√©union (sources annonc√©es : DEETS, R√©gion, Formanoo, Portail SPRO 2025-2026).</p>
              <ul>
                <li><b>Public cible</b> : formateurs FPA, apprenants adultes, entreprises, partenaires insertion</li>
                <li><b>Focus</b> : √Æle compl√®te avec priorit√© Sud</li>
                <li><b>Orientation</b> : formation + accompagnement social</li>
              </ul>
            </div>
            <div class="mm-right">
              <div class="sidebox">
                <p class="title">üè∑Ô∏è Tags</p>
                <div class="pill-row" aria-hidden="true">
                  <span class="pill">R√©union</span><span class="pill">Insertion</span><span class="pill">Annuaire</span>
                </div>
              </div>
              <div class="sidebox">
                <p class="title">‚ö° Actions</p>
                <div class="actions">
                  <div class="action"><span>Conseil : ajoute/√©dite les contenus</span><span class="k">MM_DATA</span></div>
                  <div class="action"><span>Conseil : ajoute les acteurs carte</span><span class="k">ACTEURS</span></div>
                  <div class="action"><span>Astuce : cache g√©ocodage</span><small>localStorage</small></div>
                </div>
              </div>
            </div>
          </div>
        `;
        requestAnimationFrame(() => mmCard.classList.remove("is-enter"));
      }, 40);
    }

    MM_DATA.branches.forEach(b => { mmCreateLink(b.id); mmCreateNode(b); });
    mmLayout();
    window.addEventListener("resize", mmLayout);
    mmResetBtn.addEventListener("click", mmReset);
    mmExpandBtn.addEventListener("click", () => mmActivate(MM_DATA.branches[0].id));

    /* =======================
      2) CARTE ‚Äî acteurs
    ======================= */
    const ACTEURS = [
      { id:"deets_dir", categorie:"PILOTAGE", nom:"DEETS R√©union (Direction)", commune:"Saint-Denis", adresse:"112 rue de la R√©publique, 97400 Saint-Denis, La R√©union", details:"T√©l: 02 62 94 07 07 | deets-974.direction@deets.gouv.fr" },
      { id:"deets_ctrl", categorie:"PILOTAGE", nom:"DEETS ‚Äî P√¥le Contr√¥le", commune:"Saint-Denis", adresse:"12 Lot. Lemerle, 97400 Saint-Denis, La R√©union", details:"T√©l: 02 62 90 21 41" },

      { id:"ft_sud", categorie:"SPE", nom:"France Travail ‚Äî Antenne Sud", commune:"Saint-Pierre", adresse:"40 rue Fran√ßois de Mahy, Saint-Pierre, La R√©union", details:"Contact: 39 49" },
      { id:"ml_sud_sl", categorie:"SPE", nom:"Missions Locales Sud ‚Äî Antenne Saint-Louis", commune:"Saint-Louis", adresse:"4 rue du Vieux Moulin, Saint-Louis, La R√©union", details:"T√©l: 02 62 26 28 29" },

      { id:"aftral_spaul", categorie:"OF", nom:"AFTRAL", commune:"Saint-Paul", adresse:"89 rue Henri Cornu, ZI Cambaie, Saint-Paul, La R√©union", details:"T√©l: 0262 22 17 17 | reunion@aftral.com" },
      { id:"arefip_sp", categorie:"OF", nom:"AREFIP", commune:"Saint-Pierre", adresse:"24 Cit√© Plaine, Saint-Pierre, La R√©union", details:"T√©l: 0262 96 19 79 | contact@arefip.fr" },

      { id:"cci_campuspro", categorie:"OF", nom:"CCI P√¥le Formation ‚Äî CAMPUS PRO", commune:"Saint-Pierre", adresse:"65 rue P√®re Lafosse, Saint-Pierre, La R√©union", details:"T√©l: 0262 70 99 55 | campuspro@reunion.cci.fr" },
      { id:"cci_cirfim", categorie:"OF", nom:"CCI P√¥le Formation ‚Äî CIRFIM", commune:"Le Port", adresse:"31 Av Raymond Mondon, Le Port, La R√©union", details:"T√©l: 0262 43 51 12 | cfacirfim@reunion.cci.fr" },
      { id:"cci_nord", categorie:"OF", nom:"CCI P√¥le Formation ‚Äî Nord", commune:"Saint-Denis", adresse:"12 rue Gabriel Kerveguen, Saint-Denis, La R√©union", details:"T√©l: 0262 48 35 00" },
      { id:"cci_sud", categorie:"OF", nom:"CCI P√¥le Formation ‚Äî Sud", commune:"Saint-Pierre", adresse:"15 route Balance, Saint-Pierre, La R√©union", details:"T√©l: 0262 96 96 96 | cfasud@reunion.cci.fr" },

      { id:"cefora_port", categorie:"OF", nom:"CEFORA", commune:"Le Port", adresse:"3 Av Th√©odore Drouhet, Parc 2000, Le Port, La R√©union", details:"T√©l: 0262 24 40 49 | contact@cefora.re" },
      { id:"cfa_cres_port", categorie:"OF", nom:"CFA Campus R√©union Enseignement Sup√©rieur", commune:"Le Port", adresse:"1 rue Francis Sautron, Le Port, La R√©union", details:"T√©l: 0262 29 26 26" },
      { id:"cfa_irof_sp", categorie:"OF", nom:"CFA-IROF", commune:"Saint-Pierre", adresse:"6 Impasse Georges Gilerot, Saint-Pierre, La R√©union", details:"T√©l: 0262 45 33 02 | contact@irof.re" },
      { id:"cfa_ur_sd", categorie:"OF", nom:"CFA-UR", commune:"Saint-Denis", adresse:"2 Rue Joseph Wetzell, Saint-Denis, La R√©union", details:"T√©l: 0262 52 89 24 | cfaur@univ-reunion.fr" },

      { id:"idis_port", categorie:"OF", nom:"IDIS", commune:"Le Port", adresse:"3 Rue Dupleix, Le Port, La R√©union", details:"(d√©tails non fournis dans l‚Äôextrait)" },
      { id:"ordia_port", categorie:"OF", nom:"ORDIA SARL", commune:"Le Port", adresse:"69 rue Jeanne d'Arc, Le Port, La R√©union", details:"(d√©tails non fournis dans l‚Äôextrait)" }
    ];

    const CACHE_KEY = "geo_cache_v5_reunion_acteurs";
    const cache = (() => {
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        return raw ? JSON.parse(raw) : {};
      }catch{ return {}; }
    })();
    function saveCache(){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); }catch{} }

    async function geocodeOne(address){
      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.searchParams.set("q", address);
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "1");
      const res = await fetch(url.toString(), { headers: { "Accept":"application/json" }});
      if(!res.ok) return null;
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0) return null;
      const hit = data[0];
      const lat = Number(hit.lat), lng = Number(hit.lon);
      if(!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
      return { lat, lng, display_name: hit.display_name || "" };
    }

    async function geocodeAll({force=false} = {}){
      for(const a of ACTEURS){
        const addr = (a.adresse || "").trim();
        if(!addr) continue;
        if(!force && cache[a.id] && cache[a.id].lat != null) continue;

        try{
          const hit = await geocodeOne(addr);
          cache[a.id] = hit ? { ...hit, ts: Date.now(), addr } : { lat:null, lng:null, ts: Date.now(), addr, fail:true };
          saveCache();
        }catch{
          cache[a.id] = { lat:null, lng:null, ts: Date.now(), addr, fail:true };
          saveCache();
        }

        await sleep(1000);
        renderMapAndTable();
      }
    }

    const elCat = document.getElementById("catSel");
    const elCommune = document.getElementById("communeSel");
    const elQ = document.getElementById("q");
    const elTbody = document.getElementById("tbody");
    const elCount = document.getElementById("count");
    const elPlaced = document.getElementById("placed");

    let activeId = null;

    function buildFilters(){
      const cats = Array.from(new Set(ACTEURS.map(a => a.categorie).filter(Boolean))).sort();
      for(const c of cats){
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = CAT_LABEL[c] || c;
        elCat.appendChild(opt);
      }
      const communes = Array.from(new Set(ACTEURS.map(a => a.commune).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'fr'));
      for(const c of communes){
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        elCommune.appendChild(opt);
      }
    }

    function matchesQuery(a, q){
      if(!q) return true;
      const s = (a.nom + " " + a.categorie + " " + a.commune + " " + a.adresse + " " + (a.details||"")).toLowerCase();
      return s.includes(q.toLowerCase());
    }

    function filteredActeurs(){
      const cat = elCat.value;
      const com = elCommune.value;
      const q = elQ.value.trim();
      return ACTEURS
        .filter(a => (cat === "TOUTES" ? true : a.categorie === cat))
        .filter(a => (com === "TOUTES" ? true : a.commune === com))
        .filter(a => matchesQuery(a, q));
    }

    function initMapOnce(){
      if(mapInitialized) return;
      mapInitialized = true;

      const map = L.map("map").setView([-21.115, 55.536], 10);
      window.__map = map;

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      window.__markersLayer = L.layerGroup().addTo(map);
      window.__markerById = new Map();

      buildFilters();
      renderMapAndTable();
      geocodeAll({force:false});

      document.getElementById("fitBtn").addEventListener("click", fitToMarkers);
      document.getElementById("clearBtn").addEventListener("click", () => {
        elCat.value = "TOUTES";
        elCommune.value = "TOUTES";
        elQ.value = "";
        activeId = null;
        renderMapAndTable();
        fitToMarkers();
      });
      document.getElementById("regeoBtn").addEventListener("click", async () => {
        await geocodeAll({force:true});
      });

      elCat.addEventListener("change", () => { activeId = null; renderMapAndTable(); });
      elCommune.addEventListener("change", () => { activeId = null; renderMapAndTable(); });
      elQ.addEventListener("input", () => { activeId = null; renderMapAndTable(); });
    }

    function clearMarkers(){
      if(!window.__markersLayer) return;
      window.__markersLayer.clearLayers();
      window.__markerById.clear();
    }

    function makeMarkerIcon(cat){
      const color = categoryColor(cat);
      const border = "#000000";
      const halo = "rgba(0,0,0,.18)";
      return L.divIcon({
        className: "custom-marker",
        html: `
          <div style="
            width:18px;height:18px;
            background:${color};
            border-radius:50%;
            border:3px solid ${border};
            box-shadow:0 0 0 5px ${halo}, 0 10px 20px rgba(0,0,0,.25);
          "></div>
        `,
        iconSize: [18,18],
        iconAnchor: [9,9],
        popupAnchor: [0,-10]
      });
    }

    function addMarker(actor){
      const geo = cache[actor.id];
      if(!geo || geo.lat == null || geo.lng == null) return;

      const popupHtml = `
        <div style="font-family: ui-sans-serif, system-ui; min-width:240px">
          <b>${escapeHTML(actor.nom)}</b><br/>
          <span>${escapeHTML(CAT_LABEL[actor.categorie] || actor.categorie)} ‚Äî ${escapeHTML(actor.commune)}</span>
          <div style="margin-top:6px; font-size:12px; color:#000;">
            <b>Adresse :</b> ${escapeHTML(actor.adresse)}<br/>
            ${actor.details ? `<b>D√©tails :</b> ${escapeHTML(actor.details)}` : ""}
          </div>
        </div>
      `;

      const icon = makeMarkerIcon(actor.categorie);
      const m = L.marker([geo.lat, geo.lng], { icon }).bindPopup(popupHtml);
      m.on("click", () => setActiveRow(actor.id, true));
      m.addTo(window.__markersLayer);
      window.__markerById.set(actor.id, m);
    }

    function fitToMarkers(){
      const coords = [];
      window.__markerById.forEach(m => coords.push(m.getLatLng()));
      if(coords.length === 0) return;
      window.__map.fitBounds(L.latLngBounds(coords).pad(0.20));
    }

    function setActiveRow(id, fromMarker){
      activeId = id;
      document.querySelectorAll("tr.row").forEach(tr => {
        tr.classList.toggle("active", tr.getAttribute("data-id") === id);
      });
      const m = window.__markerById.get(id);
      if(m){
        window.__map.setView(m.getLatLng(), Math.max(window.__map.getZoom(), 13), { animate:true });
        if(!fromMarker) m.openPopup();
      }
    }

    function renderMapAndTable(){
      if(!mapInitialized) return;

      const rows = filteredActeurs();

      elCount.textContent = `${rows.length} acteur${rows.length>1?"s":""}`;
      const placed = rows.filter(a => {
        const g = cache[a.id];
        return g && g.lat != null && g.lng != null;
      }).length;
      elPlaced.textContent = `${placed} plac√©s`;

      clearMarkers();
      rows.forEach(addMarker);

      elTbody.innerHTML = rows.map(a => {
        const g = cache[a.id];
        const ok = g && g.lat != null && g.lng != null;
        const active = (a.id === activeId) ? "active" : "";
        return `
          <tr class="row ${active}" data-id="${escapeHTML(a.id)}">
            <td><b>${escapeHTML(a.nom)}</b><br/><span style="color:rgba(255,255,255,.72); font-size:11px">${escapeHTML(a.details||"")}</span></td>
            <td>${escapeHTML(CAT_LABEL[a.categorie] || a.categorie)}</td>
            <td>${escapeHTML(a.commune)}</td>
            <td>${escapeHTML(a.adresse)}</td>
            <td><span class="badge ${ok?"ok":"no"}">${ok ? "plac√©" : "non plac√©"}</span></td>
          </tr>
        `;
      }).join("");

      document.querySelectorAll("tr.row").forEach(tr => {
        tr.addEventListener("click", () => {
          const id = tr.getAttribute("data-id");
          setActiveRow(id, false);
        });
      });

      if(window.__markerById.size > 0) fitToMarkers();
    }

    /* Default */
    setView("mind");
  </script>
</body>
</html>
